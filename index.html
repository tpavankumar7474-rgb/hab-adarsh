<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Leaflet -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
/>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
  html, body, #map {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
  }

  /* === Custom Cluster Colors === */
  .marker-cluster-small {
    background-color: rgba(180, 0, 0, 0.8);
    color: #fff;
    border: 2px solid #fff;
  }
  .marker-cluster-medium {
    background-color: rgba(120, 0, 0, 0.85);
    color: #fff;
    border: 2px solid #fff;
  }
  .marker-cluster-large {
    background-color: rgba(50, 0, 0, 0.9);
    color: #fff;
    border: 2px solid #fff;
  }

  .leaflet-tooltip {
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 13px;
    direction: rtl;
    text-align: right;
  }
</style>
</head>
<body>
<div id="map"></div>

<script>
  // === Initialize Map ===
  const map = L.map("map", {
    center: [28.4328, 45.9700], // ğŸŸ¢ Default center: Hafar Al-Batin
    zoom: 6,
    zoomControl: true,
    attributionControl: false,
  });

  // === Base Layer ===
  L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
    maxZoom: 14,
    minZoom: 3,
  }).addTo(map);

  // === Marker Cluster Config ===
  let markerLayer = L.markerClusterGroup({
    maxClusterRadius: 20,        // smaller value = less clustering
    disableClusteringAtZoom: 9,  // show individual points when zoomed in
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false
  });
  map.addLayer(markerLayer);

  // === Render Points ===
  function renderPoints(data) {
    markerLayer.clearLayers();

    data.forEach((row) => {
      const region = row["Ø§Ø³Ù… Ø§Ù„Ø­ÙŠ"] || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
      const lat = parseFloat(row["longitude"]);  // swapped intentionally per your SQL
      const lon = parseFloat(row["latitude"]);
      const access = row["Ø§Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„ÙŠ Ø§Ù„Ø§Ù…Ø§ÙƒÙ† Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙŠ Ù†Ø·Ø§Ù‚ 800 Ù…ØªØ±"] || "0%";
      const satisfaction = row["Ø±Ø¶Ø§_Ø§Ù„Ø³ÙƒØ§Ù† Ø¹Ù† Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©"] || "0%";

      if (!isNaN(lat) && !isNaN(lon)) {
        // Slight jitter to separate overlapping markers
        const jitterLat = lat + (Math.random() - 0.5) * 0.002;
        const jitterLon = lon + (Math.random() - 0.5) * 0.002;

        const satVal = parseFloat(satisfaction.replace("%", "")) || 0;

        const marker = L.circleMarker([jitterLat, jitterLon], {
          radius: Math.min(20, 8 + satVal / 10),
          color: "#FF3333",
          fillColor: "#FF0000",
          fillOpacity: 0.85,
          weight: 1.5,
        });

        marker.bindTooltip(
          `<b>${region}</b><br>
           Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„: ${access}<br>
           Ø±Ø¶Ø§ Ø§Ù„Ø³ÙƒØ§Ù†: ${satisfaction}`,
          { direction: "top" }
        );

        marker.on("click", function () {
          window.parent.postMessage(
            {
              type: "mapClick",
              region: region,
              latitude: lat,
              longitude: lon,
              access: access,
              satisfaction: satisfaction,
            },
            "*"
          );
        });

        markerLayer.addLayer(marker);
      }
    });

    console.log("Total rows received:", data.length);
    console.log("Markers rendered:", markerLayer.getLayers().length);

    if (markerLayer.getLayers().length > 0) {
      map.fitBounds(markerLayer.getBounds(), { padding: [30, 30] });
      map.setZoom(Math.max(map.getZoom(), 7));
    }
  }

  // === Grafana PostMessage Listener ===
  window.addEventListener("message", (event) => {
    const data = event.data;
    if (!data || !Array.isArray(data)) return;
    renderPoints(data);
  });
</script>
</body>
</html>
