<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Leaflet -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
/>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
  html, body, #map {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
  }

  /* Cluster color */
  .marker-cluster-small {
    background-color: rgba(180, 0, 0, 0.8);
    color: #fff;
    border: 2px solid #fff;
  }
  .marker-cluster-medium {
    background-color: rgba(120, 0, 0, 0.85);
    color: #fff;
    border: 2px solid #fff;
  }
  .marker-cluster-large {
    background-color: rgba(50, 0, 0, 0.9);
    color: #fff;
    border: 2px solid #fff;
  }

  .leaflet-tooltip {
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 13px;
    direction: rtl;
    text-align: right;
  }
</style>
</head>
<body>
<div id="map"></div>

<script>
  // === Initialize Map ===
  const map = L.map("map", {
    center: [24.7136, 46.6753],
    zoom: 6,
    zoomControl: true,
    attributionControl: false,
  });

  L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
    maxZoom: 12,
    minZoom: 3,
  }).addTo(map);

  let markerLayer = L.markerClusterGroup();
  map.addLayer(markerLayer);

  // === Render Points ===
  function renderPoints(data) {
    markerLayer.clearLayers();

    data.forEach((row) => {
      const region = row["اسم الحي"] || "غير معروف";
      const lat = parseFloat(row["longitude"]);  // swapped!
      const lon = parseFloat(row["latitude"]);
      const access = row["امكانية الوصول الي الاماكن العامة في نطاق 800 متر"] || "0%";
      const satisfaction = row["رضا_السكان عن الخدمات البلدية"] || "0%";

      if (!isNaN(lat) && !isNaN(lon)) {
        const satVal = parseFloat(satisfaction.replace("%", "")) || 0;

        const marker = L.circleMarker([lat, lon], {
          radius: Math.min(20, 8 + satVal / 10),
          color: "#FF3333",
          fillColor: "#FF0000",
          fillOpacity: 0.85,
          weight: 1.5,
        });

        marker.bindTooltip(
          `<b>${region}</b><br>
           إمكانية الوصول: ${access}<br>
           رضا السكان: ${satisfaction}`,
          { direction: "top" }
        );

        marker.on("click", function () {
          window.parent.postMessage(
            {
              type: "mapClick",
              region: region,
              latitude: lat,
              longitude: lon,
              access: access,
              satisfaction: satisfaction,
            },
            "*"
          );
        });

        markerLayer.addLayer(marker);
      }
    });

    if (markerLayer.getLayers().length > 0) {
      map.fitBounds(markerLayer.getBounds(), { padding: [30, 30] });
    }
  }

  // === Get data from Grafana ===
  window.addEventListener("message", (event) => {
    const data = event.data;
    if (!data || !Array.isArray(data)) return;
    renderPoints(data);
  });

  // === Test Example (for standalone run) ===
  const testData = [
    {
      "اسم الحي": "حي العليا",
      "longitude": "24.7136",
      "latitude": "46.6753",
      "امكانية الوصول الي الاماكن العامة في نطاق 800 متر": "85%",
      "رضا_السكان عن الخدمات البلدية": "90%",
    },
    {
      "اسم الحي": "حي المروج",
      "longitude": "24.7762",
      "latitude": "46.7008",
      "امكانية الوصول الي الاماكن العامة في نطاق 800 متر": "70%",
      "رضا_السكان عن الخدمات البلدية": "75%",
    },
  ];
  renderPoints(testData);
</script>
</body>
</html>
