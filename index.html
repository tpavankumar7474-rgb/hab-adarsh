<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- âœ… Leaflet -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- âœ… MarkerCluster -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
/>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
  html, body, #map {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
  }

  /* === Cluster Colors === */
  .marker-cluster-small {
    background-color: rgba(180, 0, 0, 0.8);
    color: #fff;
    border: 2px solid #fff;
  }
  .marker-cluster-medium {
    background-color: rgba(120, 0, 0, 0.85);
    color: #fff;
    border: 2px solid #fff;
  }
  .marker-cluster-large {
    background-color: rgba(50, 0, 0, 0.9);
    color: #fff;
    border: 2px solid #fff;
  }

  .leaflet-tooltip {
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 13px;
    direction: rtl;
    text-align: right;
  }
</style>
</head>
<body>
<div id="map"></div>

<script>
  // === Initialize Map ===
  const map = L.map("map", {
    center: [28.4328, 45.9700], // ğŸŸ¢ Default center: Hafar Al-Batin
    zoom: 6,
    zoomControl: true,
    attributionControl: false,
  });

  // === Base Layer ===
  L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
    maxZoom: 14,
    minZoom: 3,
  }).addTo(map);

  // === Marker Cluster Layer ===
  let markerLayer = L.markerClusterGroup({
    maxClusterRadius: 20,
    disableClusteringAtZoom: 9,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
  });
  map.addLayer(markerLayer);

  // === Render Points Function ===
  function renderPoints(data) {
    markerLayer.clearLayers();

    data.forEach((row) => {
      const region = decodeURIComponent(row.name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");
      const lat = parseFloat(row.lat);
      const lon = parseFloat(row.long);
      const access = row.access || "0%";
      const satisfaction = row.satisfaction || "0%";

      if (!isNaN(lat) && !isNaN(lon)) {
        const jitterLat = lat + (Math.random() - 0.5) * 0.002;
        const jitterLon = lon + (Math.random() - 0.5) * 0.002;

        const satVal = parseFloat(satisfaction.replace("%", "")) || 0;

        const marker = L.circleMarker([jitterLat, jitterLon], {
          radius: Math.min(20, 8 + satVal / 10),
          color: "#FF3333",
          fillColor: "#FF0000",
          fillOpacity: 0.85,
          weight: 1.5,
        });

        marker.bindTooltip(
          `<b>${region}</b><br>
           Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„: ${access}<br>
           Ø±Ø¶Ø§ Ø§Ù„Ø³ÙƒØ§Ù†: ${satisfaction}`,
          { direction: "top" }
        );

        marker.on("click", function () {
          window.parent.postMessage(
            {
              type: "mapClick",
              region: region,
              latitude: lat,
              longitude: lon,
              access: access,
              satisfaction: satisfaction,
            },
            "*"
          );
        });

        markerLayer.addLayer(marker);
      }
    });

    console.log("âœ… Total rows received:", data.length);
    console.log("âœ… Markers rendered:", markerLayer.getLayers().length);

    if (markerLayer.getLayers().length > 0) {
      map.fitBounds(markerLayer.getBounds(), { padding: [30, 30] });
      map.setZoom(Math.max(map.getZoom(), 7));
    }
  }

  // === Listen for Messages from Grafana ===
  window.addEventListener("message", (event) => {
    const payload = event.data;
    if (!payload) return;

    // âœ… Handle Grafana data
    if (payload.type === "habData" && Array.isArray(payload.data)) {
      console.log("ğŸ“© Received data from Grafana:", payload.data.length, "records");
      renderPoints(payload.data);
    }
  });
</script>
</body>
</html>
