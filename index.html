<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
  html, body, #map {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
  }

  /* Dark Cluster Colors */
  .marker-cluster-small {
    background-color: rgba(180, 0, 0, 0.8);
    color: #fff;
    border: 2px solid #fff;
  }
  .marker-cluster-medium {
    background-color: rgba(120, 0, 0, 0.85);
    color: #fff;
    border: 2px solid #fff;
  }
  .marker-cluster-large {
    background-color: rgba(50, 0, 0, 0.9);
    color: #fff;
    border: 2px solid #fff;
  }

  .leaflet-tooltip {
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 12px;
  }
</style>
</head>
<body>
<div id="map"></div>

<script>
// === Initialize map ===
const map = L.map("map", {
  center: [24.7136, 46.6753],
  zoom: 6,
  zoomControl: true,
  attributionControl: false
});

L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
  maxZoom: 12,
  minZoom: 3
}).addTo(map);

let markerLayer = L.markerClusterGroup();
map.addLayer(markerLayer);
const markerDataMap = new Map();

// === Render Points Function ===
function renderPoints(regionArr, latArr, lonArr, residentsArr, accessibilityArr) {
  markerLayer.clearLayers();
  markerDataMap.clear();

  for (let i = 0; i < regionArr.length; i++) {
    const region = decodeURIComponent(regionArr[i] || "غير معروف");
    const lat = parseFloat(latArr[i]);
    const lon = parseFloat(lonArr[i]);
    const residents = residentsArr?.[i] || "N/A";
    const accessibility = accessibilityArr?.[i] || "N/A";

    if (!isNaN(lat) && !isNaN(lon)) {
      const markerId = `${lat}_${lon}`;

      const marker = L.circleMarker([lat, lon], {
        radius: 10,
        color: "#FF3333",
        fillColor: "#FF0000",
        fillOpacity: 0.9,
        weight: 1.2
      });

      marker.bindTooltip(
        `<b>${region}</b><br>
        رضا السكان: ${residents}<br>
        إمكانية الوصول: ${accessibility}`,
        { direction: "top", opacity: 0.9 }
      );

      markerDataMap.set(markerId, {
        region, lat, long: lon, residents, accessibility
      });

      marker.on("click", function() {
        const data = markerDataMap.get(markerId);
        window.parent.postMessage({
          type: "mapClick",
          region: data.region,
          lat: data.lat,
          long: data.long,
          residents: data.residents,
          accessibility: data.accessibility
        }, "*");
      });

      markerLayer.addLayer(marker);
    }
  }

  if (markerLayer.getLayers().length > 0) {
    map.fitBounds(markerLayer.getBounds(), { padding: [30, 30] });
  }
}

// === Listen for Grafana messages ===
window.addEventListener("message", (event) => {
  const data = event.data;
  if (!data || !data.lat || !data.long) return;

  renderPoints(
    data.region || [],
    data.lat || [],
    data.long || [],
    data.residents || [],
    data.accessibility || []
  );
});

// === Support URL params (optional) ===
const params = new URLSearchParams(window.location.search);
const regions = params.get("region")?.split(",") || [];
const lats = params.get("lat")?.split(",") || [];
const lons = params.get("long")?.split(",") || [];
const residents = params.get("residents")?.split(",") || [];
const accessibility = params.get("accessibility")?.split(",") || [];

if (regions.length && lats.length && lons.length) {
  renderPoints(regions, lats, lons, residents, accessibility);
}
</script>
</body>
</html>
